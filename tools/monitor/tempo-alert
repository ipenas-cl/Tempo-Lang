#!/bin/bash
# Tempo Alert - Send intelligent alerts to SRE

if [ $# -lt 1 ]; then
    echo "âŒ Usage: tempo alert <message>"
    echo ""
    echo "Examples:"
    echo "  tempo alert 'WCET violation in payment service'"
    echo "  tempo alert 'High memory usage detected'"
    echo "  tempo alert 'Critical: Database connection failed'"
    exit 1
fi

MESSAGE="$*"

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                     ğŸš¨ TEMPO ALERT SYSTEM                                   â•‘"
echo "â•‘                    Intelligent SRE Notifications                            â•‘"
echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo ""

# Generate alert ID
ALERT_ID="TEMPO-$(date +%Y%m%d-%H%M%S)-$(printf "%04d" $RANDOM)"

echo "ğŸš¨ Processing Alert:"
echo "   ID: $ALERT_ID"
echo "   Message: $MESSAGE"
echo "   Timestamp: $(date)"
echo ""

# Analyze severity
SEVERITY="INFO"
if echo "$MESSAGE" | grep -qi "critical\|fatal\|emergency\|down"; then
    SEVERITY="CRITICAL"
elif echo "$MESSAGE" | grep -qi "warning\|high\|wcet\|violation"; then
    SEVERITY="WARNING"
fi

echo "ğŸ“Š Alert Analysis:"
echo "   Severity: $SEVERITY"
echo "   Keywords detected: $(echo "$MESSAGE" | grep -o -i 'critical\|warning\|wcet\|violation\|high' | head -3 | paste -sd ',' -)"
echo ""

# Collect system context
echo "ğŸ” System Context:"
echo "   Load Average: $(uptime | awk -F'load averages:' '{print $2}')"
echo "   Memory Pressure: $(vm_stat | grep "Pages free" | awk '{print $3}' | sed 's/\.//')KB free"
echo "   Active Processes: $(ps aux | grep -E "\.(app|tempo)|stage1" | grep -v grep | wc -l | tr -d ' ') Tempo apps"
echo ""

# Generate recommendations
echo "ğŸ’¡ Intelligent Recommendations:"
case "$SEVERITY" in
    CRITICAL)
        echo "   ğŸš¨ IMMEDIATE ACTION REQUIRED"
        echo "   ğŸ“‹ Check 'tempo monitor' for process status"
        echo "   ğŸ” Run 'tempo debug <app>' for detailed analysis"
        echo "   ğŸ“ Consider escalating to on-call engineer"
        ;;
    WARNING)
        echo "   âš ï¸  Monitor situation closely"
        echo "   ğŸ“Š Review 'tempo logs <app>' for patterns"
        echo "   ğŸ“ˆ Check performance with 'tempo profile <app>'"
        echo "   ğŸ”§ Consider optimization or scaling"
        ;;
    *)
        echo "   ğŸ“ Log for trend analysis"
        echo "   ğŸ“Š Continue monitoring with 'tempo monitor'"
        ;;
esac

echo ""

# Log the alert
LOG_FILE="/tmp/tempo-alerts.log"
echo "$(date '+%Y-%m-%d %H:%M:%S') [$SEVERITY] $ALERT_ID: $MESSAGE" >> "$LOG_FILE"

echo "âœ… Alert Processing Complete:"
echo "   ğŸ“§ Alert logged to: $LOG_FILE"
echo "   ğŸ”” Notification channels: Console"
echo "   ğŸ“Š Alert ID: $ALERT_ID"
echo ""

echo "ğŸ”§ Integration Available:"
echo "   Slack: Export SLACK_WEBHOOK_URL"
echo "   Email: Configure sendmail"
echo "   PagerDuty: Set PAGERDUTY_KEY"
echo ""

echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
